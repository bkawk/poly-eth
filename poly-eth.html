<link rel="import" href="../polymer/polymer.html">
<script src="../web3/dist/web3.min.js" async></script>
<script src="../eth-util-browserified/eth-util.min.js" async></script>

<!--
`poly-eth`

@demo demo/index.html
-->

<dom-module id="poly-eth">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
  </template>

  <script>
    class MyElement extends Polymer.Element {
      static get is() { return 'poly-eth'; }
      static get properties() {
        return {
          web3: {
            type: Object
          },
        };
      }

    connectedCallback(){
      super.connectedCallback();
      this.restoreAddress('dfs ddssd  qwer qwer qwer qwer qwer q fsd fsd ', 'S3df3s#df!defdf')
      // this.makeAddress('sDfsd907f@#sdf')
      // this.getPassphrase('sDfsd907f@#sdf')
    }
    
    makeAddress(vaultPassword){
      Promise.all([this._checkLocalStorage('isNull'), this._strengthTest(vaultPassword), this._passphrase()])
      .then((data) => {
        return Promise.all([this._makeAddress(data[2]), this._encrypt(data[2], vaultPassword)])
      })
      .then((data) => {
        this._saveLocalStorage(data[0], data[1])
      })
      .catch((err) => {
        console.error(err)
      })
    }

    getPassphrase(vaultPassword){
      Promise.all([this._checkLocalStorage('notNull'), this._strengthTest(vaultPassword)])
      .then((data) => {
        return this._decrypt(vaultPassword)
      })
      .catch((err) => {
        console.error(err)
      })
    }

    restoreAddress(passphrase, vaultPassword){
      // check the passphrase is strong
      Promise.all([this._deleteLocalStorage(), this._strengthTest(vaultPassword)])
      .then((data) => {
        return Promise.all([this._makeAddress(passphrase), this._encrypt(passphrase, vaultPassword)])
      })
      .then((data) => {
        this._saveLocalStorage(data[0], data[1])
      })
      .catch((err) => {
        console.error(err)
      })
    }

    changeVaultPassword(passphrase, oldVaultPassword, newVaultPassword){
      // check the passphrase is strong
      // if there is local storage and new and old passwords are strong
      // decrypt wallet
      // compare passphrase from wallet with passphrase
      // if they mathch delete vault and encrypt passphrase with newVaultPassword 
      // save vault to local storage
    }

    transferEth(fromAddress, toAddress, ethAmount, metaData){

    }

    _convertCurrency(symbolPair, amount){
      return new Promise((resolve, reject) => {
      // ETHxUSD
      // USDxETH
      })
    }
    _createEthTransatoin(){
      return new Promise((resolve, reject) => {
      
      })
    }
    _signEthTransaction(){
      return new Promise((resolve, reject) => {
      
      })
    }
    _sendEthTransaction(){
      return new Promise((resolve, reject) => {
      
      })
    }
    _gethConnect(){
      return new Promise((resolve, reject) => {
        if (typeof web3 !== 'undefined') {
          this.web3 = new Web3(web3.currentProvider);
        } else {
          this.web3 = new Web3(new Web3.providers.HttpProvider("http://eth.bkawk.com"));
        }
      })
    }
    _makeAddress(passphrase){
      return new Promise((resolve, reject) => {
        resolve(`0x${eth.util.privateToAddress(eth.util.sha3(passphrase)).toString('hex')}`)
      })
    }
    _passphrase(){
      return new Promise((resolve, reject) => {
        resolve(eth.bip39.generateMnemonic())
      })
    }
    _strengthTest(password){
      return new Promise((resolve, reject) => {
        if(!eth.strength.test(password).strong){
          reject(eth.strength.test(password).errors)
        } else {
          resolve(true)
        }
      })
    }
    _checkLocalStorage(val){
      return new Promise((resolve, reject) => {
        if(val == 'isNull'){
          if(localStorage.getItem("vault")){
            reject('vault')
          } else {
            resolve(true)
          }
        }
        if(val == 'notNull'){
          if(!localStorage.getItem("vault")){
            reject('vault')
          } else {
            resolve(true)
          }
        }
      })
    }
    _deleteLocalStorage(){
      return new Promise((resolve, reject) => {
        if (typeof(Storage) !== "undefined") {
          localStorage.removeItem('vault');
          resolve(true)
        } else {
          reject('vault')
        }
      })
    }
    _saveLocalStorage(address, passphrase){
      return new Promise((resolve, reject) => {
        if (typeof(Storage) !== "undefined") {
          localStorage.setItem("vault", JSON.stringify({ "ethAddress": address, "passphrase": passphrase}));
          resolve(true)
        } else {
          reject('vault')
        }
      })
    }
    _encrypt(passphrase, password){
      return new Promise((resolve, reject) => {
        var password = new Uint8Array(eth.util.sha3(password));
        var textBytes = eth.aes.utils.utf8.toBytes(passphrase);
        var aesCtr = new eth.aes.ModeOfOperation.ctr(password, new eth.aes.Counter(5));
        var encryptedBytes = aesCtr.encrypt(textBytes);
        var encryptedHex = eth.aes.utils.hex.fromBytes(encryptedBytes);
        console.log(encryptedHex);
        resolve(encryptedHex);
      })
    }
    _decrypt(password){
      return new Promise((resolve, reject) => {
        var password = new Uint8Array(eth.util.sha3(password));
        var encryptedHex = JSON.parse(localStorage.getItem("vault")).passphrase;
        var encryptedBytes = eth.aes.utils.hex.toBytes(encryptedHex);
        var aesCtr = new eth.aes.ModeOfOperation.ctr(password, new eth.aes.Counter(5));
        var decryptedBytes = aesCtr.decrypt(encryptedBytes);
        var decryptedText = eth.aes.utils.utf8.fromBytes(decryptedBytes);
        resolve(decryptedText);
      })
    }
    _gtEthBalance(account){
      this.web3.eth.getBalance(account, 'latest', (err, result) => {
        if (err) { 
          console.error("Error while retrieving the balance for address " + err);
        } else {
          console.debug("Balance = "+ Number(this.web3.fromWei(result, "ether")) ); 
        }            
      }); 
    }

    } window.customElements.define(MyElement.is, MyElement);
  </script>
</dom-module>
