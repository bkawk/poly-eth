<link rel="import" href="../polymer/polymer.html">
<script src="../web3/dist/web3.min.js" async></script>
<script src="../eth-util-browserified/eth-util.min.js" async></script>

<!--
`poly-eth`

@demo demo/index.html
-->

<dom-module id="poly-eth">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>
  </template>

  <script>
    class MyElement extends Polymer.Element {
      static get is() { return 'poly-eth'; }
      static get properties() {
        return {
          web3: {
            type: Object
          },
        };
      }

    connectedCallback(){
      super.connectedCallback();
      // this.restoreAddress('dfs ddssd  qwer qwer qwer qwer qwer q fsd fsd ', 'S3df3s#df!defdf')
      // this.makeAddress('sDfsd907f@#sdf')
      // this.getPassphrase('sDfsd907f@#sdf')
      // changeVaultPassword(passphrase, oldVaultPassword, newVaultPassword)
      // this.changeVaultPassword('dfs ddssd  qwer qwer qwer qwer qwer q fsd fsd ', 'sDfsd907f@#sdf', 'NEWsDfsd907f@#sdf')
      // this._getEthBallance('0x1488e397bc44c56d801a6e96217554a0e310ecb5')
      // this._ethFx(100, 'usd', 'X-ETH')
      // this._getEthNonce('0x1488e397bc44c56d801a6e96217554a0e310ecb5')
      // this._getGasPrice()
      // this._createEthTransation('0x1488e397bc44c56d801a6e96217554a0e310ecb5', '0x1488e397bc44c56d801a6e96217554a0e310ecb5', 0.001, 'some data')
      // this._getEthAddress()
      this._byteLimit('this is more than 32 bit string length and will fail', 32)
    }
    
    makeAddress(vaultPassword){
      Promise.all([this._checkLocalStorage('isNull'), this._strengthTest(vaultPassword), this._passphrase()])
      .then((data) => {
        return Promise.all([this._makeAddress(data[2]), this._encrypt(data[2], vaultPassword)])
      })
      .then((data) => {
        this._saveLocalStorage(data[0], data[1])
      })
      .catch((err) => {
        console.error(err)
      })
    }

    getPassphrase(vaultPassword){
      Promise.all([this._checkLocalStorage('notNull'), this._strengthTest(vaultPassword)])
      .then(() => {
        return this._decrypt(vaultPassword)
      })
      .catch((err) => {
        console.error(err)
      })
    }

    restoreAddress(passphrase, vaultPassword){
      Promise.all([this._deleteLocalStorage(), this._strengthTest(vaultPassword)])
      .then((data) => {
        return Promise.all([this._makeAddress(passphrase), this._encrypt(passphrase, vaultPassword)])
      })
      .then((data) => {
        this._saveLocalStorage(data[0], data[1])
      })
      .catch((err) => {
        console.error(err)
      })
    }

    changeVaultPassword(passphrase, oldVaultPassword, newVaultPassword){
      Promise.all([this._strengthTest(oldVaultPassword), this._strengthTest(newVaultPassword), this._checkLocalStorage('notNull')])
      .then(() => {
        return this._decrypt(oldVaultPassword)
      })
      .then((vaultPassphrase) => {
        return this._compare(passphrase, vaultPassphrase)
      })
      .then(() => {
        return Promise.all([this._deleteLocalStorage(), this._makeAddress(passphrase), this._encrypt(passphrase, newVaultPassword)])
      })
      .then((data) => {
        this._saveLocalStorage(data[1], data[2])
      })
      .catch((err) => {
        console.error(err)
      })
    }

    transferEth(toAddress, ethAmount, data, vaultPassword){
      var fromAddress, nonce, gasPrice, vaultPassphrase
      Promise.all([this._getEthNonce(fromAddress), this._getGasPrice(), this._getEthAddress()])
      .then((data) => {
        nonce = data[0]
        gasPrice = data[1]
        fromAddress = data[2]
        return Promise.all([this._checkLocalStorage('notNull'), this._strengthTest(vaultPassword)])
      })
      .then(() => {
        return this._decrypt(vaultPassword)
      })
      .then((passphrase) => {
        vaultPassphrase = passphrase
        return this._createEthTransation(nonce, toAddress, gasPrice, ethAmount, data)
      })
      .then((rawTx) => {
        return this._signEthTransaction(rawTx, vaultPassphrase)
      })
      .then((signedTx) => {
        this._sendEthTransaction(signedTx)
      })
      .catch((err) => {
        console.error(err)
      })
    }

    _byteLimit(string, maxBytes) {
      return new Promise((resolve, reject) => {   
        var byteLength = encodeURI(string).split(/%..|./).length - 1;
        console.log(byteLength);
        if(byteLength > maxBytes){
          console.log('FAIL');
          reject(Error("_byteLimit: The string was longer than maxBytes"))
        } else {
          console.log('PASS');
          resolve(true)
        }
      })
    }
    _createEthTransation(nonce, toAddress, gasPrice, ethAmount, data){
      return new Promise((resolve, reject) => {  
        if(nonce && toAddress && gasPrice && ethAmount && data){    
          var rawTx = {
              nonce : this.web3.toHex(nonce),
              to : toAddress,
              gasPrice : this.web3.toHex(gasPrice),
              gasLimit : this.web3.toHex(21000),
              value : this.web3.toHex(this.web3.toWei(ethAmount, 'ether')),
              data : this.web3.toHex(data) || ""
          }
          resolve(rawTx)
        } else {
          reject(Error("_createEthTransation: A value is missing"))
        }
      })
    }
    _signEthTransaction(rawTx, vaultPassphrase){
      return new Promise((resolve, reject) => {
        if(rawTx && vaultPassphrase){
          var passphraseHex = this.web3.toHex(vaultPassphrase)
          var privateKey = new Buffer(passphraseHex, 'hex')
          var tx = new Tx(rawTx);
          tx.sign(privateKey);
          var serializedTx = tx.serialize();
          console.log(serializedTx.toString('hex'));
          resolve(serializedTx.toString('hex'))
        } else {
          reject(Error("_signEthTransaction: A value is missing"))
        }
      })
    }
    _sendEthTransaction(signedTx){
      return new Promise((resolve, reject) => {
        this._gethConnect()
        this.web3.eth.sendRawTransaction(signedTx, function(err, hash) {
          if (!err){
            console.log(hash)
            resolve(hash)
          } else {
            reject()
          }    
        });
      })
    }
    _getGasPrice(){
      return new Promise((resolve, reject) => {
        this._gethConnect()
          this.web3.eth.getGasPrice((error, gasPrice) => {
            if(!error){
            resolve(gasPrice.toString(10))
            } else {
              reject()
            }
          })
      })
    }
    _getEthNonce(address){
      return new Promise((resolve, reject) => {
        this._gethConnect()
        this.web3.eth.getTransactionCount(address, (error, nonce) => {
          if(!error){
            console.log(nonce)
            resolve(nonce)
          } else {
            reject()
          }
        })
      })
    }
    _getEthBallance(address){
      return new Promise((resolve, reject) => {
        this._gethConnect()
        this.web3.eth.getBalance(address, (error, balance) => {
          if(!error){
            resolve(balance.toString(10))
          } else {
            reject()
          }
        })
      })
    }
    _ethFx(amount, currencyCode, direction){
      return new Promise((resolve, reject) => {
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = function() {
          if (xmlhttp.readyState == XMLHttpRequest.DONE ) {
            if (xmlhttp.status == 200) {
              var price = JSON.parse(xmlhttp.responseText).price;
              var fx
              switch (currencyCode) {
                case 'aud': fx = price.aud; break;
                case 'brl': fx = price.brl; break;
                case 'btc': fx = price.btc; break;
                case 'cad': fx = price.cad; break;
                case 'chf': fx = price.chf; break;
                case 'cny': fx = price.cny; break;
                case 'eur': fx = price.eur; break;
                case 'gbp': fx = price.gbp; break;
                case 'hkd': fx = price.hkd; break;
                case 'idr': fx = price.idr; break;
                case 'inr': fx = price.inr; break;
                case 'jpy': fx = price.jpy; break;
                case 'krw': fx = price.krw; break;
                case 'mxn': fx = price.mxn; break;
                case 'rub': fx = price.rub; break;
                case 'usd': fx = price.usd;
              }
              if(direction == 'X-ETH'){
                resolve(amount / fx)
              } else {
                resolve(amount * fx)
              }
            }
            else if (xmlhttp.status == 400) {
              reject('There was an error 400');
            }
            else {
              reject('something else other than 200 was returned');
            }
          }
        };
      xmlhttp.open("GET", "https://coinmarketcap-nexuist.rhcloud.com/api/eth", true);
      xmlhttp.send();
      })
    }
    _compare(thisItem, thatItem){
      return new Promise((resolve, reject) => {
        if(thisItem === thatItem){
          resolve(true)
        } else {
          reject(false)
        }
      })
    }
    _gethConnect(){
      return new Promise((resolve, reject) => {
        if (typeof web3 !== 'undefined') {
          this.web3 = new Web3(web3.currentProvider);
        } else {
          this.web3 = new Web3(new Web3.providers.HttpProvider("http://eth.bkawk.com"));
        }
      })
    }
    _makeAddress(passphrase){
      return new Promise((resolve, reject) => {
        resolve(`0x${eth.util.privateToAddress(eth.util.sha3(passphrase)).toString('hex')}`)
      })
    }
    _passphrase(){
      return new Promise((resolve, reject) => {
        resolve(eth.bip39.generateMnemonic())
      })
    }
    _strengthTest(password){
      return new Promise((resolve, reject) => {
        if(!eth.strength.test(password).strong){
          reject(eth.strength.test(password).errors)
        } else {
          resolve(true)
        }
      })
    }
    _checkLocalStorage(val){
      return new Promise((resolve, reject) => {
        if(val == 'isNull'){
          if(localStorage.getItem("vault")){
            reject('vault')
          } else {
            resolve(true)
          }
        }
        if(val == 'notNull'){
          if(!localStorage.getItem("vault")){
            reject('vault')
          } else {
            resolve(true)
          }
        }
      })
    }
    _getEthAddress(){
      return new Promise((resolve, reject) => {
        console.log(JSON.parse(localStorage.getItem('vault')).ethAddress)
        resolve(JSON.parse(localStorage.getItem('vault')).ethAddress) 
      })
    }
    _deleteLocalStorage(){
      return new Promise((resolve, reject) => {
        if (typeof(Storage) !== "undefined") {
          localStorage.removeItem('vault');
          resolve(true)
        } else {
          reject('vault')
        }
      })
    }
    _saveLocalStorage(address, passphrase){
      return new Promise((resolve, reject) => {
        if (typeof(Storage) !== "undefined") {
          localStorage.setItem("vault", JSON.stringify({ "ethAddress": address, "passphrase": passphrase}));
          resolve(true)
        } else {
          reject('vault')
        }
      })
    }
    _encrypt(passphrase, password){
      return new Promise((resolve, reject) => {
        var password = new Uint8Array(eth.util.sha3(password));
        var textBytes = eth.aes.utils.utf8.toBytes(passphrase);
        var aesCtr = new eth.aes.ModeOfOperation.ctr(password, new eth.aes.Counter(5));
        var encryptedBytes = aesCtr.encrypt(textBytes);
        var encryptedHex = eth.aes.utils.hex.fromBytes(encryptedBytes);
        resolve(encryptedHex);
      })
    }
    _decrypt(password){
      return new Promise((resolve, reject) => {
        var password = new Uint8Array(eth.util.sha3(password));
        var encryptedHex = JSON.parse(localStorage.getItem("vault")).passphrase;
        var encryptedBytes = eth.aes.utils.hex.toBytes(encryptedHex);
        var aesCtr = new eth.aes.ModeOfOperation.ctr(password, new eth.aes.Counter(5));
        var decryptedBytes = aesCtr.decrypt(encryptedBytes);
        var decryptedText = eth.aes.utils.utf8.fromBytes(decryptedBytes);
        resolve(decryptedText);
      })
    }


    } window.customElements.define(MyElement.is, MyElement);
  </script>
</dom-module>
